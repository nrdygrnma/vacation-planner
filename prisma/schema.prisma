generator client {
  provider   = "prisma-client-js"
  engineType = "binary"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Airline {
  code String @id
  name String
}

model Currency {
  id             String          @id @default(cuid())
  name           String          @unique
  symbol         String          @unique
  accommodations Accommodation[]
  carRentals     CarRental[]
  flights        Flight[]
  trips          Trip[]
}

model Trip {
  id                  String       @id @default(cuid())
  title               String
  startDate           DateTime?
  endDate             DateTime?
  people              Int          @default(1)
  totalCostEUR        Decimal
  currencyId          String
  selectedFlightId    String?      @unique
  selectedCarRentalId String?      @unique
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt
  imageUrl            String?
  carRentals          CarRental[]  @relation("TripCarRentals")
  flights             Flight[]     @relation("TripFlights")
  selectedCarRental   CarRental?   @relation("SelectedCarOnTrip", fields: [selectedCarRentalId], references: [id])
  selectedFlight      Flight?      @relation("SelectedFlightOnTrip", fields: [selectedFlightId], references: [id])
  currency            Currency     @relation(fields: [currencyId], references: [id])
  tripStops           TripStop[]
  tripOptions         TripOption[]

  @@index([startDate])
  @@index([endDate])
}

model TripOption {
  id           String    @id @default(cuid())
  tripId       String
  name         String
  startDate    DateTime?
  endDate      DateTime?
  people       Int?
  totalCostEUR Decimal?
  isPreferred  Boolean   @default(false)

  // chosen items for this option
  selectedFlightId    String? @unique
  selectedCarRentalId String? @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  trip       Trip        @relation(fields: [tripId], references: [id])
  flights    Flight[]    @relation("OptionFlights")
  carRentals CarRental[] @relation("OptionCarRentals")

  selectedFlight    Flight?    @relation("SelectedFlightOnOption", fields: [selectedFlightId], references: [id])
  selectedCarRental CarRental? @relation("SelectedCarOnOption", fields: [selectedCarRentalId], references: [id])

  @@index([tripId])
  @@index([isPreferred])
}

model Flight {
  id                      String    @id @default(cuid())
  airline                 String
  fromAirport             String
  toAirport               String
  departureDate           DateTime?
  arrivalDate             DateTime?
  travelClass             String
  baseFare                Decimal
  extras                  String?
  currencyId              String
  totalCostEUR            Decimal
  tripId                  String
  tripOptionId            String?
  flightNumber            String?
  stops                   Int?      @default(0)
  bookingUrl              String?
  notes                   String?
  durationMin             Int?
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
  stopOverAirports        String?
  stopOverDurationMinutes Int?
  segments                String?

  currency       Currency @relation(fields: [currencyId], references: [id])
  trip           Trip     @relation("TripFlights", fields: [tripId], references: [id], onDelete: Cascade)
  selectedOnTrip Trip?    @relation("SelectedFlightOnTrip")

  // ðŸ”¹ Main option relation (1 option â†’ many flights)
  tripOption       TripOption? @relation("OptionFlights", fields: [tripOptionId], references: [id])
  // ðŸ”¹ Optionâ€™s chosen flight (1 option â†’ 1 selected flight)
  selectedOnOption TripOption? @relation("SelectedFlightOnOption")

  @@index([tripId])
  @@index([tripId, departureDate])
  @@index([tripId, totalCostEUR])
  @@index([tripOptionId])
}

model CarType {
  id      String      @id @default(cuid())
  name    String
  rentals CarRental[]
}

model CarRental {
  id              String    @id @default(cuid())
  provider        String
  carTypeId       String?
  pickupDate      DateTime?
  dropoffDate     DateTime?
  pickupLocation  String
  dropoffLocation String
  baseRate        Decimal
  fees            Decimal?
  insurancePerDay Decimal?
  currencyId      String
  totalCostEUR    Decimal?
  tripId          String
  tripOptionId    String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  carType  CarType? @relation(fields: [carTypeId], references: [id])
  currency Currency @relation(fields: [currencyId], references: [id])
  trip     Trip     @relation("TripCarRentals", fields: [tripId], references: [id], onDelete: Cascade)

  selectedOnTrip Trip? @relation("SelectedCarOnTrip")

  // ðŸ”¹ Main option relation (1 option â†’ many rentals)
  tripOption       TripOption? @relation("OptionCarRentals", fields: [tripOptionId], references: [id])
  // ðŸ”¹ Optionâ€™s chosen car (1 option â†’ 1 selected rental)
  selectedOnOption TripOption? @relation("SelectedCarOnOption")

  @@index([tripId])
  @@index([tripOptionId])
}

model TripStop {
  id                      String          @id @default(cuid())
  name                    String
  startDate               DateTime
  endDate                 DateTime
  lat                     Float?
  lng                     Float?
  selectedAccommodationId String?         @unique
  tripId                  String
  createdAt               DateTime        @default(now())
  updatedAt               DateTime        @updatedAt
  accommodations          Accommodation[] @relation("TripStopAccommodation")
  selectedAccommodation   Accommodation?  @relation("SelectedAccommodationOnStop", fields: [selectedAccommodationId], references: [id])
  trip                    Trip            @relation(fields: [tripId], references: [id])
}

model Accommodation {
  id             String    @id @default(cuid())
  name           String
  provider       String?
  roomType       String?
  nightlyRate    Decimal?
  totalCostEUR   Decimal?
  currencyId     String
  tripStopId     String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  currency       Currency  @relation(fields: [currencyId], references: [id])
  tripStop       TripStop? @relation("TripStopAccommodation", fields: [tripStopId], references: [id])
  selectedOnStop TripStop? @relation("SelectedAccommodationOnStop")
}
